#!/usr/bin/env ruby

require "fileutils"
require "optparse"
require "pathname"

require "rubygems"
require "castoro-s3-adapter"

require "castoro-s3-adapter/scripts/script_runner"

COMMAND_OPTIONS = {
  :start => {
    :verbose => false,
    :daemon => false,
    :pid => "/var/castoro/s3-adapter.pid",
    :log => "/var/castoro/s3-adapter.log",
    :conf => "/etc/castoro/s3-adapter.conf",
    :env => "default",
  },
  :stop => {
    :verbose => false,
    :force => false,
    :pid => "/var/castoro/s3-adapter.pid",
  },
  :setup => {
    :verbose => false,
    :conf => "/etc/castoro/s3-adapter.conf",
  },
}

def help
  puts "#{File.basename(__FILE__)} <command>"
  puts
  puts "Available commands:"
  COMMAND_OPTIONS.keys.each { |c| puts "\t#{c}" }
  puts
end

# get command.
command = ARGV.shift.to_s.to_sym
unless COMMAND_OPTIONS.include? command
  help
  exit 1
end

opt = COMMAND_OPTIONS[command].dup

parser = OptionParser.new { |parser|
  parser.program_name = "#{File.basename(__FILE__)} #{command}"

  case command
  when :start
    parser.on('-v', '--verbose', 'verbose') { |v|
      opt[:verbose] = true
    }
    parser.on('-d', '--daemon', 'daemon mode') { |v|
      opt[:daemon] = true
    }
    parser.on('-p PID', '--pid <pidfile>', 'PID file (only for the daemon mode)') { |v|
      if Pathname.new(v).absolute?
        opt[:pid] = Pathname.new(v).to_s
      else
        opt[:pid] = Pathname.new(File.join(Pathname.pwd, v)).to_s
      end
      dir = File.dirname(opt[:pid])
      FileUtils.mkdir_p(dir) unless File.exist?(dir)
    }
    parser.on('-l LOG', '--log <logfile>', 'Log file (only for the daemon mode)') { |v|
      if Pathname.new(v).absolute?
        opt[:log] = Pathname.new(v).to_s
      else
        opt[:log] = Pathname.new(File.join(Pathname.pwd, v)).to_s
      end
      dir = File.dirname(opt[:log])
      FileUtils.mkdir_p(dir) unless File.exist?(dir)
    }
    parser.on('-c CNF', '--conf <configfile>', 'Config file') { |v|
      if Pathname.new(v).absolute?
        opt[:conf] = Pathname.new(v).to_s
      else
        opt[:conf] = Pathname.new(File.join(Pathname.pwd, v)).to_s
      end
    }
    parser.on('-e ENV', '--env <environment>', 'Execution environment') { |v|
      opt[:env] = v
    }

  when :stop
    parser.on('-v', '--verbose', 'verbose') { |v|
      opt[:verbose] = true
    }
    parser.on('-f', '--force', 'force shutdown') { |v|
      opt[:force] = true
    }
    parser.on('-p PID', '--pid <pidfile>', 'PID file') { |v|
      if Pathname.new(v).absolute?
        opt[:pid] = Pathname.new(v).to_s
      else
        opt[:pid] = Pathname.new(File.join(Pathname.pwd, v)).to_s
      end
    }

  when :setup
    parser.on('-v', '--verbose', 'verbose') { |v|
      opt[:verbose] = true
    }
    parser.on('-f', '--force', 'Override config file') { |v|
      opt[:force] = true
    }
    parser.on('-c CNF', '--conf <configfile>', 'Config file') { |v|
      if Pathname.new(v).absolute?
        opt[:conf] = Pathname.new(v).to_s
      else
        opt[:conf] = Pathname.new(File.join(Pathname.pwd, v)).to_s
      end
    }

  end

}

begin
  parser.parse!(ARGV)
rescue
  puts parser.help
  exit 1
end

Castoro::S3Adapter::ScriptRunner.send(command, opt)

